<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * {
        box-sizing: border-box;
      }
      
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: Arial, sans-serif;
      }
      
      .container {
        padding: 30px;
        width: 100%;
        min-height: 100vh;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      
      .header h1 {
        margin: 0 0 10px 0;
        font-size: 28px;
        color: #333;
      }
      
      .header .subtitle {
        font-size: 16px;
        color: #666;
        margin-bottom: 20px;
      }
      
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 25px;
      }
      
      .section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #e1e5e9;
      }
      
      .section-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .section-title::before {
        font-size: 20px;
      }
      
      .section.staff .section-title::before {
        content: "üë•";
      }
      
      .section.absence .section-title::before {
        content: "üìÖ";
      }
      
      .section.privacy .section-title::before {
        content: "üîí";
      }
      
      .section.backup .section-title::before {
        content: "üíæ";
      }
      
      .info-text {
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
      }
      
      .form-group {
        margin-bottom: 15px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }
      
      .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .form-group input:focus {
        outline: none;
        border-color: #4285f4;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.1);
      }
      
      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
      }
      
      .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      
      .btn-primary {
        background-color: #4285f4;
        color: white;
      }
      
      .btn-primary:hover {
        background-color: #3367d6;
      }
      
      .btn-secondary {
        background-color: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
      }
      
      .btn-secondary:hover {
        background-color: #e0e0e0;
      }
      
      .btn-danger {
        background-color: #dc3545;
        color: white;
      }
      
      .btn-danger:hover {
        background-color: #c82333;
      }
      
      .staff-list {
        margin-top: 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
      }
      
      .staff-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .staff-item:last-child {
        border-bottom: none;
      }
      
      .staff-info {
        flex-grow: 1;
      }
      
      .staff-info .name {
        font-weight: 500;
        color: #333;
      }
      
      .staff-info .details {
        font-size: 13px;
        color: #666;
        margin-top: 2px;
      }
      
      .staff-actions {
        display: flex;
        gap: 5px;
      }
      
      .staff-actions .btn {
        padding: 4px 8px;
        font-size: 12px;
        min-height: auto;
      }
      
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
      }
      
      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      }
      
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }
      
      .modal-header h3 {
        margin: 0;
        color: #333;
      }
      
      .close {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
        line-height: 1;
      }
      
      .close:hover {
        color: #333;
      }
      
      .footer {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .status-message {
        margin-top: 15px;
        padding: 12px;
        border-radius: 6px;
        font-size: 14px;
      }
      
      .success {
        background-color: #d6f5d6;
        color: #2e7d32;
        border: 1px solid #4caf50;
      }
      
      .error {
        background-color: #ffcdd2;
        color: #c62828;
        border: 1px solid #f44336;
      }
      
      .info {
        background-color: #e3f2fd;
        color: #1565c0;
        border: 1px solid #2196f3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>‚öôÔ∏è Settings</h1>
        <div class="subtitle">Configure your Staff Rota Manager preferences</div>
      </div>
      
      <div class="content">
        <!-- Staff Management Section -->
        <div class="section staff">
          <div class="section-title">Staff Management</div>
          <div class="info-text">
            Manage staff members and their details for rota generation.
          </div>
          
          <div class="button-group">
            <button class="btn btn-secondary" id="addStaffButton">
              ‚ûï Add New Staff
            </button>
            <button class="btn btn-secondary" id="importStaffButton">
              üì• Import Staff List
            </button>
          </div>

          <div id="staffList" class="staff-list">
            <!-- Staff list will be populated here -->
          </div>
        </div>

        <!-- Absence Settings Section -->
        <div class="section absence">
          <div class="section-title">Absence Settings</div>
          <div class="info-text">
            Configure absence tracking and reporting preferences.
          </div>
          
          <div class="form-group">
            <label for="annualLeaveAllowanceInput">Annual Leave Allowance (days):</label>
            <input type="number" id="annualLeaveAllowanceInput" value="25" min="0" max="365">
            <div class="info-text">Default annual leave allowance for new staff members.</div>
          </div>
        </div>

        <!-- Privacy & Analytics Section -->
        <div class="section privacy">
          <div class="section-title">Privacy & Analytics</div>
          <div class="info-text">
            Control your privacy settings and data usage preferences.
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="analyticsEnabledCheckbox" checked>
            <label for="analyticsEnabledCheckbox">Enable anonymous usage analytics</label>
          </div>
          <div class="info-text">Help us improve the add-on by sharing anonymous usage statistics.</div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="notificationsEnabledCheckbox">
            <label for="notificationsEnabledCheckbox">Enable notifications</label>
          </div>
          <div class="info-text">Receive notifications about new features and updates.</div>
          
          <div class="button-group" style="margin-top: 15px;">
            <button class="btn btn-secondary" id="exportDataButton">
              üì§ Export My Data
            </button>
            <button class="btn btn-danger" id="deleteDataButton">
              üóëÔ∏è Delete My Data
            </button>
          </div>
          <div class="info-text">Export or delete your personal data in compliance with GDPR/CCPA.</div>
        </div>

        <!-- Backup & Export Section -->
        <div class="section backup">
          <div class="section-title">Backup & Export</div>
          <div class="info-text">
            Create backups of rota data or export for reporting purposes.
          </div>
          
          <div class="button-group">
            <button class="btn btn-secondary" id="backupButton">
              üíæ Create Backup
            </button>
            <button class="btn btn-secondary" id="exportRotaButton">
              üìä Export Rota Data
            </button>
          </div>
        </div>
      </div>
      
      <div id="statusMessage" style="display: none;" class="status-message"></div>
      
      <div class="footer">
        <div style="font-size: 13px; color: #666;">
          üí° Changes are saved automatically
        </div>
        <button class="btn btn-primary" id="saveSettingsButton">
          ‚úÖ Save All Settings
        </button>
      </div>

      <!-- Staff Modal -->
      <div id="staffModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3 id="modalTitle">Add New Staff</h3>
            <span class="close" onclick="closeStaffModal()">&times;</span>
          </div>
          <form id="staffForm">
            <input type="hidden" id="staffId">
            <div class="form-group">
              <label for="staffName">Full Name:</label>
              <input type="text" id="staffName" required>
            </div>
            <div class="form-group">
              <label for="staffEmail">Email:</label>
              <input type="email" id="staffEmail" required>
            </div>
            <div class="form-group">
              <label for="staffRole">Role:</label>
              <input type="text" id="staffRole" required>
            </div>
            <div class="button-group">
              <button type="button" class="btn btn-secondary" onclick="closeStaffModal()">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <script>
      // Global variables
      let staffList = [];
      let editingStaffId = null;
      
      // Initialize the page
      document.addEventListener('DOMContentLoaded', function() {
        // Set up event handlers
        document.getElementById('saveSettingsButton').addEventListener('click', saveSettings);
        document.getElementById('addStaffButton').addEventListener('click', () => showStaffModal());
        document.getElementById('importStaffButton').addEventListener('click', showImportStaffDialog);
        document.getElementById('backupButton').addEventListener('click', createBackup);
        document.getElementById('exportRotaButton').addEventListener('click', exportRotaData);
        document.getElementById('staffForm').addEventListener('submit', handleStaffFormSubmit);
        
        // Privacy controls event handlers
        const exportDataBtn = document.getElementById('exportDataButton');
        const deleteDataBtn = document.getElementById('deleteDataButton');
        
        if (exportDataBtn) {
          exportDataBtn.addEventListener('click', exportUserData);
        }
        
        if (deleteDataBtn) {
          deleteDataBtn.addEventListener('click', confirmDeleteUserData);
        }
        
        // Load current settings
        loadPrivacySettings();
        loadStaffList();
      });
      
      // Save settings
      function saveSettings() {
        const annualLeaveAllowance = document.getElementById('annualLeaveAllowanceInput').value;
        const analyticsEnabled = document.getElementById('analyticsEnabledCheckbox').checked;
        const notificationsEnabled = document.getElementById('notificationsEnabledCheckbox').checked;
        
        // Validate annual leave allowance
        if (isNaN(annualLeaveAllowance) || annualLeaveAllowance < 0) {
          showMessage('Please enter a valid annual leave allowance.', 'error');
          return;
        }
        
        showMessage('Saving settings...', 'info');
        
        // Save privacy settings
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Settings saved successfully!', 'success');
            } else {
              showMessage('Error saving settings: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error saving settings: ' + error.message, 'error');
          })
          .updatePrivacySettings({
            analyticsEnabled: analyticsEnabled,
            notificationsEnabled: notificationsEnabled,
            annualLeaveAllowance: annualLeaveAllowance
          });
      }
      
      // Load current privacy settings
      function loadPrivacySettings() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              const settings = result.settings;
              document.getElementById('analyticsEnabledCheckbox').checked = settings.analyticsEnabled || false;
              document.getElementById('notificationsEnabledCheckbox').checked = settings.notificationsEnabled || false;
              document.getElementById('annualLeaveAllowanceInput').value = settings.annualLeaveAllowance || 25;
            }
          })
          .withFailureHandler(function(error) {
            console.log('Error loading privacy settings:', error);
          })
          .getPrivacySettings();
      }
      
      // Export user data
      function exportUserData() {
        showMessage('Preparing data export...', 'info');
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Create download link for the exported data
              const dataStr = JSON.stringify(result.data, null, 2);
              const dataBlob = new Blob([dataStr], {type: 'application/json'});
              const url = URL.createObjectURL(dataBlob);
              
              const link = document.createElement('a');
              link.href = url;
              link.download = `staff-rota-data-export-${new Date().toISOString().split('T')[0]}.json`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              
              showMessage('Data exported successfully!', 'success');
            } else {
              showMessage('Error exporting data: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error exporting data: ' + error.message, 'error');
          })
          .exportUserData();
      }
      
      // Confirm and delete user data
      function confirmDeleteUserData() {
        const confirmation = prompt(
          'WARNING: This will permanently delete your user preferences and settings.\n\n' +
          'Your spreadsheet data will NOT be affected.\n\n' +
          'To confirm, type: DELETE_MY_DATA'
        );
        
        if (confirmation === 'DELETE_MY_DATA') {
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showMessage('Your data has been deleted successfully.', 'success');
              } else {
                showMessage('Error deleting data: ' + result.message, 'error');
              }
            })
            .withFailureHandler(function(error) {
              showMessage('Error deleting data: ' + error.message, 'error');
            })
            .deleteUserData(confirmation);
        } else if (confirmation !== null) {
          showMessage('Data deletion cancelled - incorrect confirmation code.', 'error');
        }
      }
      
      // Staff Management Functions
      function loadStaffList() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              staffList = result.staff || [];
              renderStaffList();
            } else {
              showMessage('Error loading staff list: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error loading staff list: ' + error.message, 'error');
          })
          .getStaffList();
      }

      function renderStaffList() {
        const staffListElement = document.getElementById('staffList');
        staffListElement.innerHTML = '';

        if (staffList.length === 0) {
          staffListElement.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No staff members added yet. Click "Add New Staff" to get started.</div>';
          return;
        }

        staffList.forEach(staff => {
          const staffItem = document.createElement('div');
          staffItem.className = 'staff-item';
          staffItem.innerHTML = `
            <div class="staff-info">
              <div class="name">${staff.name}</div>
              <div class="details">${staff.role} ‚Ä¢ ${staff.email}</div>
            </div>
            <div class="staff-actions">
              <button class="btn btn-secondary" onclick="editStaff('${staff.id}')">‚úèÔ∏è Edit</button>
              <button class="btn btn-danger" onclick="deleteStaff('${staff.id}')">üóëÔ∏è</button>
            </div>
          `;
          staffListElement.appendChild(staffItem);
        });
      }

      function showStaffModal(staffId = null) {
        const modal = document.getElementById('staffModal');
        const modalTitle = document.getElementById('modalTitle');
        const form = document.getElementById('staffForm');
        
        editingStaffId = staffId;
        modalTitle.textContent = staffId ? 'Edit Staff Member' : 'Add New Staff';
        
        if (staffId) {
          const staff = staffList.find(s => s.id === staffId);
          if (staff) {
            document.getElementById('staffId').value = staff.id;
            document.getElementById('staffName').value = staff.name;
            document.getElementById('staffEmail').value = staff.email;
            document.getElementById('staffRole').value = staff.role;
          }
        } else {
          form.reset();
        }
        
        modal.style.display = 'block';
      }

      function closeStaffModal() {
        const modal = document.getElementById('staffModal');
        modal.style.display = 'none';
        editingStaffId = null;
      }

      function handleStaffFormSubmit(event) {
        event.preventDefault();
        
        const staffData = {
          id: document.getElementById('staffId').value,
          name: document.getElementById('staffName').value,
          email: document.getElementById('staffEmail').value,
          role: document.getElementById('staffRole').value
        };

        if (editingStaffId) {
          updateStaff(staffData);
        } else {
          addStaff(staffData);
        }
      }

      function addStaff(staffData) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Staff member added successfully!', 'success');
              closeStaffModal();
              loadStaffList();
            } else {
              showMessage('Error adding staff member: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error adding staff member: ' + error.message, 'error');
          })
          .addStaffMember(staffData);
      }

      function updateStaff(staffData) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Staff member updated successfully!', 'success');
              closeStaffModal();
              loadStaffList();
            } else {
              showMessage('Error updating staff member: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error updating staff member: ' + error.message, 'error');
          })
          .updateStaffMember(staffData);
      }

      function deleteStaff(staffId) {
        if (confirm('Are you sure you want to delete this staff member?')) {
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showMessage('Staff member deleted successfully!', 'success');
                loadStaffList();
              } else {
                showMessage('Error deleting staff member: ' + result.message, 'error');
              }
            })
            .withFailureHandler(function(error) {
              showMessage('Error deleting staff member: ' + error.message, 'error');
            })
            .deleteStaffMember(staffId);
        }
      }

      function editStaff(staffId) {
        showStaffModal(staffId);
      }
      
      // Show import staff dialog
      function showImportStaffDialog() {
        showMessage('Import staff feature will open a file selection dialog.', 'info');
        // This would typically show a file upload dialog
      }
      
      // Create backup
      function createBackup() {
        showMessage('Creating backup...', 'info');
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Backup created successfully! Check your Google Drive.', 'success');
            } else {
              showMessage('Error creating backup: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error creating backup: ' + error.message, 'error');
          })
          .createSpreadsheetBackup();
      }
      
      // Export rota data
      function exportRotaData() {
        showMessage('Exporting rota data...', 'info');
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Rota data exported successfully!', 'success');
            } else {
              showMessage('Error exporting rota data: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error exporting rota data: ' + error.message, 'error');
          })
          .exportRotaData();
      }
      
      // Show message
      function showMessage(message, type) {
        const messageElement = document.getElementById('statusMessage');
        messageElement.textContent = message;
        messageElement.className = 'status-message ' + type;
        messageElement.style.display = 'block';
        
        // Auto-hide success/info messages after 4 seconds
        if (type === 'success' || type === 'info') {
          setTimeout(function() {
            messageElement.style.display = 'none';
          }, 4000);
        }
      }
      
      // Close modal when clicking outside
      window.onclick = function(event) {
        const modal = document.getElementById('staffModal');
        if (event.target === modal) {
          closeStaffModal();
        }
      }
    </script>
  </body>
</html>