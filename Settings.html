<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      .container {
        padding: 15px;
        font-family: Arial, sans-serif;
      }
      
      h3 {
        margin-top: 0;
        margin-bottom: 15px;
      }
      
      .section {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
      }
      
      .section-title {
        font-weight: bold;
        margin-bottom: 10px;
      }
      
      label {
        display: block;
        margin-bottom: 5px;
      }
      
      select, input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      
      .button-container {
        margin-top: 20px;
        text-align: right;
      }
      
      button {
        padding: 8px 15px;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
      }
      
      button:hover {
        background-color: #3367d6;
      }
      
      button.secondary {
        background-color: #f5f5f5;
        color: #333;
      }
      
      button.secondary:hover {
        background-color: #e0e0e0;
      }
      
      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
      }
      
      .success {
        background-color: #d6f5d6;
        color: #2e7d32;
      }
      
      .error {
        background-color: #ffcdd2;
        color: #c62828;
      }
      
      .info-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        margin-bottom: 15px;
      }

      /* Staff Management Styles */
      .staff-list {
        margin-top: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
      }

      .staff-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .staff-item:last-child {
        border-bottom: none;
      }

      .staff-info {
        flex-grow: 1;
      }

      .staff-actions {
        display: flex;
        gap: 5px;
      }

      .staff-actions button {
        padding: 4px 8px;
        font-size: 12px;
        margin: 0;
      }

      .staff-actions .edit {
        background-color: #f5f5f5;
        color: #333;
      }

      .staff-actions .delete {
        background-color: #dc3545;
        color: white;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
      }

      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 4px;
        width: 80%;
        max-width: 500px;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .close {
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
      }

      .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h3>Staff Rota Settings</h3>
      
      <div class="section">
        <div class="section-title">Staff Management</div>
        <div class="info-text">
          Manage staff members and their details.
        </div>
        
        <div>
          <button class="secondary" id="addStaffButton">Add New Staff</button>
          <button class="secondary" id="importStaffButton">Import Staff List</button>
        </div>

        <div id="staffList" class="staff-list">
          <!-- Staff list will be populated here -->
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Absence Settings</div>
        <div class="info-text">
          Configure absence tracking and reporting.
        </div>
        
        <label for="annualLeaveAllowanceInput">Annual Leave Allowance (days):</label>
        <input type="number" id="annualLeaveAllowanceInput" value="25" min="0" max="365">
        
        <div class="info-text">
          This is the default annual leave allowance for new staff members.
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Privacy & Analytics</div>
        <div class="info-text">
          Control your privacy settings and data usage.
        </div>
        
        <label>
          <input type="checkbox" id="analyticsEnabledCheckbox" checked>
          Enable anonymous usage analytics
        </label>
        <div class="info-text">
          Help us improve the add-on by sharing anonymous usage statistics.
        </div>
        
        <label>
          <input type="checkbox" id="notificationsEnabledCheckbox">
          Enable notifications
        </label>
        <div class="info-text">
          Receive notifications about new features and updates.
        </div>
        
        <div style="margin-top: 15px;">
          <button class="secondary" id="exportDataButton">Export My Data</button>
          <button class="secondary" id="deleteDataButton" style="background-color: #dc3545; color: white;">Delete My Data</button>
        </div>
        <div class="info-text">
          Export or delete your personal data in compliance with GDPR/CCPA.
        </div>
      </div>
      
      <div class="section">
        <div class="section-title">Backup & Export</div>
        <div class="info-text">
          Create backups of rota data or export for reporting.
        </div>
        
        <div>
          <button class="secondary" id="exportDataButton">Export Data</button>
          <button class="secondary" id="backupButton">Create Backup</button>
        </div>
      </div>
      
      <div id="statusMessage" style="display: none;" class="status-message"></div>
      
      <div class="button-container">
        <button id="saveSettingsButton">Save Settings</button>
      </div>

      <!-- Staff Modal -->
      <div id="staffModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h4 id="modalTitle">Add New Staff</h4>
            <span class="close" onclick="closeStaffModal()">&times;</span>
          </div>
          <form id="staffForm">
            <input type="hidden" id="staffId">
            <div class="form-group">
              <label for="staffName">Full Name:</label>
              <input type="text" id="staffName" required>
            </div>
            <div class="form-group">
              <label for="staffEmail">Email:</label>
              <input type="email" id="staffEmail" required>
            </div>
            <div class="form-group">
              <label for="staffRole">Role:</label>
              <input type="text" id="staffRole" required>
            </div>
            <div class="button-container">
              <button type="button" class="secondary" onclick="closeStaffModal()">Cancel</button>
              <button type="submit">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <script>
      // Global variables
      let staffList = [];
      let editingStaffId = null;
      
      // Initialize the page
      document.addEventListener('DOMContentLoaded', function() {
        // Set up event handlers
        document.getElementById('saveSettingsButton').addEventListener('click', saveSettings);
        document.getElementById('addStaffButton').addEventListener('click', () => showStaffModal());
        document.getElementById('importStaffButton').addEventListener('click', showImportStaffDialog);
        document.getElementById('backupButton').addEventListener('click', createBackup);
        document.getElementById('staffForm').addEventListener('submit', handleStaffFormSubmit);
        
        // Privacy controls event handlers
        const exportDataBtn = document.getElementById('exportDataButton');
        const deleteDataBtn = document.getElementById('deleteDataButton');
        
        if (exportDataBtn) {
          exportDataBtn.addEventListener('click', exportUserData);
        }
        
        if (deleteDataBtn) {
          deleteDataBtn.addEventListener('click', confirmDeleteUserData);
        }
        
        // Load current settings
        loadPrivacySettings();
        loadStaffList();
      });
      
      // Save settings
      function saveSettings() {
        const annualLeaveAllowance = document.getElementById('annualLeaveAllowanceInput').value;
        const analyticsEnabled = document.getElementById('analyticsEnabledCheckbox').checked;
        const notificationsEnabled = document.getElementById('notificationsEnabledCheckbox').checked;
        
        // Validate annual leave allowance
        if (isNaN(annualLeaveAllowance) || annualLeaveAllowance < 0) {
          showMessage('Please enter a valid annual leave allowance.', 'error');
          return;
        }
        
        // Save privacy settings
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Settings saved successfully!', 'success');
            } else {
              showMessage('Error saving settings: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error saving settings: ' + error.message, 'error');
          })
          .updatePrivacySettings({
            analyticsEnabled: analyticsEnabled,
            notificationsEnabled: notificationsEnabled
          });
      }
      
      // Load current privacy settings
      function loadPrivacySettings() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              const settings = result.settings;
              document.getElementById('analyticsEnabledCheckbox').checked = settings.analyticsEnabled;
              document.getElementById('notificationsEnabledCheckbox').checked = settings.notificationsEnabled;
            }
          })
          .withFailureHandler(function(error) {
            console.log('Error loading privacy settings:', error);
          })
          .getPrivacySettings();
      }
      
      // Export user data
      function exportUserData() {
        showMessage('Preparing data export...', 'info');
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Create download link for the exported data
              const dataStr = JSON.stringify(result.data, null, 2);
              const dataBlob = new Blob([dataStr], {type: 'application/json'});
              const url = URL.createObjectURL(dataBlob);
              
              const link = document.createElement('a');
              link.href = url;
              link.download = `staff-rota-data-export-${new Date().toISOString().split('T')[0]}.json`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              
              showMessage('Data exported successfully!', 'success');
            } else {
              showMessage('Error exporting data: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error exporting data: ' + error.message, 'error');
          })
          .exportUserData();
      }
      
      // Confirm and delete user data
      function confirmDeleteUserData() {
        const confirmation = prompt(
          'WARNING: This will permanently delete your user preferences and settings.\\n\\n' +
          'Your spreadsheet data will NOT be affected.\\n\\n' +
          'To confirm, type: DELETE_MY_DATA'
        );
        
        if (confirmation === 'DELETE_MY_DATA') {
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showMessage('Your data has been deleted successfully.', 'success');
              } else {
                showMessage('Error deleting data: ' + result.message, 'error');
              }
            })
            .withFailureHandler(function(error) {
              showMessage('Error deleting data: ' + error.message, 'error');
            })
            .deleteUserData(confirmation);
        } else if (confirmation !== null) {
          showMessage('Data deletion cancelled - incorrect confirmation code.', 'error');
        }
      }
      
      // Staff Management Functions
      function loadStaffList() {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              staffList = result.staff;
              renderStaffList();
            } else {
              showMessage('Error loading staff list: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error loading staff list: ' + error.message, 'error');
          })
          .getStaffList();
      }

      function renderStaffList() {
        const staffListElement = document.getElementById('staffList');
        staffListElement.innerHTML = '';

        staffList.forEach(staff => {
          const staffItem = document.createElement('div');
          staffItem.className = 'staff-item';
          staffItem.innerHTML = `
            <div class="staff-info">
              <strong>${staff.name}</strong>
              <div>${staff.role}</div>
              <div style="font-size: 12px; color: #666;">${staff.email}</div>
            </div>
            <div class="staff-actions">
              <button class="edit" onclick="editStaff('${staff.id}')">Edit</button>
              <button class="delete" onclick="deleteStaff('${staff.id}')">Delete</button>
            </div>
          `;
          staffListElement.appendChild(staffItem);
        });
      }

      function showStaffModal(staffId = null) {
        const modal = document.getElementById('staffModal');
        const modalTitle = document.getElementById('modalTitle');
        const form = document.getElementById('staffForm');
        
        editingStaffId = staffId;
        modalTitle.textContent = staffId ? 'Edit Staff Member' : 'Add New Staff';
        
        if (staffId) {
          const staff = staffList.find(s => s.id === staffId);
          if (staff) {
            document.getElementById('staffId').value = staff.id;
            document.getElementById('staffName').value = staff.name;
            document.getElementById('staffEmail').value = staff.email;
            document.getElementById('staffRole').value = staff.role;
          }
        } else {
          form.reset();
        }
        
        modal.style.display = 'block';
      }

      function closeStaffModal() {
        const modal = document.getElementById('staffModal');
        modal.style.display = 'none';
        editingStaffId = null;
      }

      function handleStaffFormSubmit(event) {
        event.preventDefault();
        
        const staffData = {
          id: document.getElementById('staffId').value,
          name: document.getElementById('staffName').value,
          email: document.getElementById('staffEmail').value,
          role: document.getElementById('staffRole').value
        };

        if (editingStaffId) {
          updateStaff(staffData);
        } else {
          addStaff(staffData);
        }
      }

      function addStaff(staffData) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Staff member added successfully!', 'success');
              closeStaffModal();
              loadStaffList();
            } else {
              showMessage('Error adding staff member: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error adding staff member: ' + error.message, 'error');
          })
          .addStaffMember(staffData);
      }

      function updateStaff(staffData) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Staff member updated successfully!', 'success');
              closeStaffModal();
              loadStaffList();
            } else {
              showMessage('Error updating staff member: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error updating staff member: ' + error.message, 'error');
          })
          .updateStaffMember(staffData);
      }

      function deleteStaff(staffId) {
        if (confirm('Are you sure you want to delete this staff member?')) {
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showMessage('Staff member deleted successfully!', 'success');
                loadStaffList();
              } else {
                showMessage('Error deleting staff member: ' + result.message, 'error');
              }
            })
            .withFailureHandler(function(error) {
              showMessage('Error deleting staff member: ' + error.message, 'error');
            })
            .deleteStaffMember(staffId);
        }
      }

      function editStaff(staffId) {
        showStaffModal(staffId);
      }
      
      // Show import staff dialog
      function showImportStaffDialog() {
        // This would typically show a dialog for staff import
        showMessage('Import staff feature not implemented in this demo.', 'info');
      }
      
      // Create backup
      function createBackup() {
        showMessage('Creating backup...', 'info');
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              showMessage('Backup created successfully! Check your Google Drive.', 'success');
            } else {
              showMessage('Error creating backup: ' + result.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            showMessage('Error creating backup: ' + error.message, 'error');
          })
          .createSpreadsheetBackup();
      }
      
      // Show message
      function showMessage(message, type) {
        const messageElement = document.getElementById('statusMessage');
        messageElement.textContent = message;
        messageElement.className = 'status-message ' + type;
        messageElement.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(function() {
          messageElement.style.display = 'none';
        }, 5000);
      }
    </script>
  </body>
</html> 